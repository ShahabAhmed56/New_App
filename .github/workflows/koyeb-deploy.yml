name: Koyeb Nightly Deployment (Only If Code Changed)

on:
  schedule:
    # Runs daily at 2:00 AM Pakistan Time (UTC +5)
    # GitHub Actions uses UTC â†’ 21:00 UTC = 2:00 AM PKT
    - cron: "10 19 * * *"

  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if code changed since last commit
        id: changes
        run: |
          if git diff --quiet HEAD^ HEAD; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Skip deployment (no changes)
        if: steps.changes.outputs.changed == 'false'
        run: echo "No code changes detected. Skipping Koyeb deployment."

      - name: Deploy to Koyeb
        if: steps.changes.outputs.changed == 'true'
        run: |
          curl -X POST "https://app.koyeb.com/v1/services/${{ secrets.KOYEB_SERVICE_ID }}/redeploy" \
          -H "Authorization: Bearer ${{ secrets.KOYEB_TOKEN }}"
