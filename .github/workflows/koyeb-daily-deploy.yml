name: Daily Deploy to Koyeb (new-app)

on:
  # 1:00 AM PKT = 20:00 UTC (previous day)
  schedule:
    - cron: "10 12 * * *"
  workflow_dispatch: {}

concurrency:
  group: koyeb-new-app-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Install Koyeb CLI
        run: |
          curl -fsSL https://get.koyeb.com/install.sh | sh
          echo "$HOME/.koyeb/bin" >> $GITHUB_PATH

      - name: Redeploy service on Koyeb
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
        run: |
          koyeb service redeploy new-app
