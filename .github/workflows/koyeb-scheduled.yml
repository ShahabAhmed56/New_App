name: Koyeb Daily Deploy (Scheduler)

on:
  # 1:00 AM PKT = 20:00 UTC (previous day)
  schedule:
    - cron: "50 7 * * *"
  workflow_dispatch: {}

concurrency:
  group: koyeb-daily-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Install Koyeb CLI
        run: |
          curl -fsSL https://get.koyeb.com/install.sh | sh
          echo "$HOME/.koyeb/bin" >> $GITHUB_PATH

      - name: Verify Koyeb CLI + Token
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
        run: |
          koyeb version
          # This should succeed; if it fails, token is wrong/missing
          koyeb services list || (echo "KOYEB_TOKEN not working" && exit 1)

      - name: Redeploy Koyeb service
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
        run: |
          # IMPORTANT: service name must match EXACTLY what Koyeb shows
          koyeb service redeploy new-app

      # OPTIONAL: Replace with your real koyeb public URL to confirm site updated
      # - name: Smoke test website
      #   run: |
      #     curl -I https://YOUR_PUBLIC_KOYEB_URL
